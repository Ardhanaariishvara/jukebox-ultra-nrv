<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/styleGlobal.css') }}">
    <script type="text/javascript" src="{{ url_for('static', filename='scripts/jquery-3.2.1.min.js') }}"></script>
    <link rel= "stylesheet" type= "text/css" href= "../static/styles/styleGlobal.css    ">


    <title>Page Accueil</title>
</head>
<body>



<div class="listMusique" id="playlistEnCours">
</div>

<header>
    <div class="formRecherche">
    <form id="formRecherche">
        <input name="q" id="imputRecherche" type="text" placeholder="Recherchez un morceau"
                spellcheck="false" dir="ltr" style="text-align: left; direction: ltr;" autocomplete="off"
                aria-expanded="false"/>
        <div class="list_result" id="listresultat">
        </div>
    </form>
    </div>
    <div class="login">
        {% if user == None %}
        Coucou {{ mac }} <a href="/auth">j'aimerais bien savoir ton p'tit nom :o</a>
        {% else %}
        Coucou {{ user }} :) tu as la mac {{ mac }}
        {% endif %}
    </div>
</header>

<script>
    /// partie synchronisation

    var IntervalID;
    var temps;
    var musicNowPlaying = false;
    donneeChanson();
    function donneeChanson() {
    var xhttp_sync = new XMLHttpRequest();
    xhttp_sync.onreadystatechange = function(){
        if(this.readyState == 4 && this.status == 200)
        {
            console.log(xhttp_sync.responseText);
            json = JSON.parse(xhttp_sync.responseText);
            var ItemsPlaylist = [].slice.call(document.getElementById("playlistEnCours").getElementsByClassName("ItemMusique"));
            ItemsPlaylist.forEach(function(div){
                if(div.getAttribute("url") === json.playlist[0]){
                    json.playlist.splice(0,1);
                }else{
                    div.remove();
                }
            });

            json.playlist.forEach(function(morceau){
                if([].slice.call(document.getElementById("playlistEnCours").getElementsByClassName("ItemMusique")).length === 0){
                    document.getElementById("playlistEnCours").innerHTML +=
                        '<div class="ItemMusique" url="'+ morceau.url + '" id="Lecture_en_cours">' +
                        '<div class="imageAlbum">' +
                        '<img src="' + morceau.albumart_url + '"/>' +
                        '</div>' +
                        '<div class="infosMusique">' +
                        '<h1>' + morceau.track + '</h1>' +
                        '<h2>' + morceau.artist + " - " + morceau.album + '</h2>' +
                        '<div class="ProgressBarCV">' +
                        '<div class="ContainerStandard ContenuProgressBarCV" id="contenuProgressBar" style="width:0%"></div>' +
                        '</div>' +
                        '<span id="dureeMorceau"> </span>' + '<span> / ' +  Math.trunc( morceau.duration / 60 ) + ':' + morceau.duration % 60 + '</span>' +
                        '</div>' +
                        '</div>';
                }else {
                    document.getElementById("playlistEnCours").innerHTML +=
                        '<div class="ItemMusique" url="'+ morceau.url + '">' +
                        '<div class="imageAlbum">' +
                        '<img src="' + morceau.albumart_url + '"/>' +
                        '</div>' +
                        '<div class="infosMusique">' +
                        '<h1>' + morceau.track + '</h1>' +
                        '<h2>' + morceau.artist + " - " + morceau.album + '</h2>' +
                        '</div>' +
                        '</div>';
                }
            });
            temps = json.time;
            if(temps > -1) {
                if (temps % 60 < 10) {
                    document.getElementById("dureeMorceau").innerHTML = Math.trunc(temps / 60) + ':0' + temps % 60;
                } else {
                    document.getElementById("dureeMorceau").innerHTML = Math.trunc(temps / 60) + ':' + temps % 60;
                }
            }
            // document.getElementById("contenuProgressBar").setAttribute("url", (temps / json.playlist[0].duration * 100).toString() + "%");
            if(ItemsPlaylist.length > 0){musicNowPlaying = true;}
            else {musicNowPlaying = false;}
        }
    };
    xhttp_sync.open("GET", "sync", true);
    xhttp_sync.send();
    }

    function majTemps() {
        if(musicNowPlaying){
            console.log("mettre a jour temps");
            document.getElementById("dureeMorceau").innerHTML = Math.trunc(temps / 60) + ':' + temps % 60;
            // document.getElementById("contenuProgressBar").setAttribute("url", (temps / json.playlist[0].duration * 100).toString() + "%");
            temps = temps + 1;
        }
    }
    setInterval(donneeChanson,5000);
    setInterval(majTemps, 1000);

    ///  afficher résultat barre de recherche

    //  Liste des résultats de la recherche
    var listResultatsAffiches = [];

    //  fonction qui envoie au serveur l'URL du morceau a ajouter à la playlist
    function ajouterALaPlaylist()
    {
        var xhttp_add = new XMLHttpRequest();
        xhttp_add.open("GET", "add/" + this.getAttribute("id"), true);
        xhttp_add.send();
        afficher_resultat({});  //  La fonction est désormais bien faite
        document.getElementById("imputRecherche").value = '';
        donneeChanson();
    }

    //  fonction a executer à chaque fois que le serveur nous envoie de nouvelles informations sur la recherche
    function afficher_resultat(json)
    {
        console.log(json);

        //  On supprime les anciennes recherches
        listResultatsAffiches.forEach(function (element) {
            element.removeEventListener('click', ajouterALaPlaylist);
        });
        listResultatsAffiches = [];
        document.getElementById("listresultat").innerHTML = '';

        if(Array.isArray(json) && document.getElementById("imputRecherche").value !== ''){
            //  On ajoute les nouvelles
            json.forEach(function (morceau) {
                document.getElementById("listresultat").innerHTML +=
                    '<div class="ItemMusique itemDeRecherche" id="' + morceau.url + '" >' +
                    '<div class="imageAlbum">' +
                    '<img src="' + morceau.albumart_url + '"/>' +
                    '</div>' +
                    '<div class="infosMusique">' +
                    '<h3>' + morceau.track + '</h3>' +
                    '<h4>' + morceau.artist + '</h4>' +
                    '</div>' +
                    '</div>';
            });


            //  On ajoute le listener d'évènement pour ajouter le morceau cliqué à la playlist
            listResultatsAffiches = [].slice.call(document.getElementsByClassName("itemDeRecherche"));
            console.log(listResultatsAffiches);
            listResultatsAffiches.forEach(function (element) {
                element.addEventListener('click', ajouterALaPlaylist);
            });
        }
    }

    /// Variable qui contient le timer sur la fonction envoyant les recherches au serveur
    var timerEffectuerRecherche;

    /// Fonction effetuant la recherche d'un morceau sur le serveur
    function effectuerRecherche() {
        console.log('une recheche a été envoyé au serveur');
        var xhttp_ask = new XMLHttpRequest();
            xhttp_ask.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    console.log(xhttp_ask.responseText);
                    afficher_resultat(JSON.parse(xhttp_ask.responseText));
                }
            };
            xhttp_ask.open("GET", "search/" + document.getElementById("imputRecherche").value, true);
            xhttp_ask.send();
    }

    /// Détection de l'appui sur une touche
    document.getElementById("imputRecherche").addEventListener("keyup", function(){
        if(document.getElementById("imputRecherche").value.length < 4){
            afficher_resultat({});
        }else{
            clearTimeout(timerEffectuerRecherche);
            timerEffectuerRecherche = setTimeout(effectuerRecherche, 300);
        }
    });

    /// Fonction qui écoute le focus sur la barre de recherche
    document.getElementById("formRecherche").addEventListener("focus", function(){
        console.log('Gain du focus de la barre de recherche');
        if(document.getElementById("imputRecherche").value.length < 4){
            afficher_resultat({});
        }else{

            var xhttp_ask = new XMLHttpRequest();
            xhttp_ask.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    console.log(xhttp_ask.responseText);
                    afficher_resultat(JSON.parse(xhttp_ask.responseText));
                }
            };
            xhttp_ask.open("GET", "search/" + document.getElementById("imputRecherche").value, true);
            xhttp_ask.send();
        }
    }, true);

    ///  Fonction de perte de focus sur la zone de recherche
    document.getElementById("playlistEnCours").addEventListener("focus", function(){
        console.log('Perte du focus de la barre de recherche');
        afficher_resultat({});  //  La fonction est désormais bien faite
    }, true);


</script>

</body>
</html>