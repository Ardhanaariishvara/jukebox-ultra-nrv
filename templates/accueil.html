<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/styleGlobal.css') }}">
    <script type="text/javascript" src="{{ url_for('static', filename='scripts/jquery-3.2.1.min.js') }}"></script>
    <link rel= "stylesheet" type= "text/css" href= "../static/styles/styleGlobal.css    ">


    <title>Page Accueil</title>
</head>
<body>

<div class="listMusique" id="playlistEnCours">


</div>

<header>
    <form class="formRecherche">
        <input name="q" id="imputRecherche" type="text" placeholder="Recherchez un morceau"
                spellcheck="false" dir="ltr" style="text-align: left; direction: ltr;"
                aria-expanded="false"/>
        <div class="list_result" id="listresultat">
        </div>
    </form>
</header>

<script>
    /// partie synchronisation

    var xhttp_sync = new XMLHttpRequest();
    xhttp_sync.onreadystatechange = function(){
        if(this.readyState == 4 && this.status == 200)
        {
            json = JSON.parse(xhttp_sync.responseText);
            var ItemsPlaylist = [].slice.call(document.getElementById("playlistEnCours").getElementsByClassName("ItemMusique"));
            ItemsPlaylist.forEach(function(div){
                if(div.getAttribute("url") === json.playlist[0]){
                    json.playlist.splice(0,1);
                }else{
                    div.remove();
                }
            });
            json.playlist.forEach(function(morceau){
                if([].slice.call(document.getElementById("playlistEnCours").getElementsByClassName("ItemMusique")).length === 0){
                    document.getElementById("playlistEnCours").innerHTML +=
                        '<div class="ItemMusique" url="'+ morceau.url + '" id="Lecture_en_cours">' +
                        '<div class="imageAlbum">' +
                        '<img src="' + morceau.albumart_url + '"/>' +
                        '</div>' +
                        '<div class="infosMusique">' +
                        '<h1>' + morceau.track + '</h1>' +
                        '<h2>' + morceau.artist + " - " + morceau.album + '</h2>' +
                        '<div class="ProgressBarCV">' +
                        '<div class="ContainerStandard ContenuProgressBarCV" id="contenuProgressBar" style="width:45%"></div>' +
                        '</div>' +
                        '<p id="dureeMorceau"> / ' + Math.trunc( morceau.duration / 60 ) + ':' + morceau.duration % 60 + '</p>' +
                        '</div>' +
                        '</div>';
                }else {
                    document.getElementById("playlistEnCours").innerHTML +=
                        '<div class="ItemMusique" url="'+ morceau.url + '">' +
                        '<div class="imageAlbum">' +
                        '<img src="' + morceau.albumart_url + '"/>' +
                        '</div>' +
                        '<div class="infosMusique">' +
                        '<h1>' + morceau.track + '</h1>' +
                        '<h2>' + morceau.artist + morceau.album + '</h2>' +
                        '</div>' +
                        '</div>';
                }
            });

            document.getElementById("dureeMorceau").innerHTML = Math.trunc(json.time / 60) + ':' + json.time % 60 + document.getElementById("dureeMorceau").innerHTML;
            document.getElementById("contenuProgressBar").setAttribute("url", (json.time / json.playlist[0].duration * 100).toString() + "%");
        }
    };
    xhttp_sync.open("GET", "sync", true);
    xhttp_sync.send();



    ///  afficher résultat barre de recherche

    //  Liste des résultats de la recherche
    var listResultatsAffiches = [];

    //  fonction qui envoie au serveur l'URL du morceau a ajouter à la playlist
    function ajouterALaPlaylist()
    {
        var xhttp_add = new XMLHttpRequest();
        xhttp_add.open("GET", "add/" + this.getAttribute("id"), true);
        xhttp_add.send();
    }

    //  fonction a executer à chaque fois que le serveur nous envoie de nouvelles informations sur la recherche
    function afficher_resultat(json)
    {
        console.log(json);

        if(Array.isArray(json) && document.getElementById("imputRecherche").value !== ''){
            //  On supprime les anciennes recherches
            listResultatsAffiches.forEach(function (element) {
                element.removeEventListener('click', ajouterALaPlaylist);
            });
            listResultatsAffiches = [];
            //  On ajoute les nouvelles
            document.getElementById("listresultat").innerHTML = '';
            json.forEach(function (morceau) {
                document.getElementById("listresultat").innerHTML +=
                    '<div class="ItemMusique itemDeRecherche" id="' + morceau.url + '" >' +
                    '<div class="imageAlbum">' +
                    '<img src="' + morceau.albumart_url + '"/>' +
                    '</div>' +
                    '<div class="infosMusique">' +
                    '<h3>' + morceau.track + '</h3>' +
                    '<h4>' + morceau.artist + '</h4>' +
                    '</div>' +
                    '</div>';
            });


            //  On ajoute le listener d'évènement pour ajouter le morceau clické à la playliste
            listResultatsAffiches = [].slice.call(document.getElementsByClassName("itemDeRecherche"));
            console.log(listResultatsAffiches);
            listResultatsAffiches.forEach(function (element) {
                element.addEventListener('click', ajouterALaPlaylist);
            });
        }else{
            document.getElementById("listresultat").innerHTML = '';
        }
    }

    document.getElementById("imputRecherche").addEventListener("keyup", function(){
        if(document.getElementById("imputRecherche").value === ''){
            afficher_resultat({});
        }else{

            var xhttp_ask = new XMLHttpRequest();
            xhttp_ask.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    console.log(xhttp_ask.responseText);
                    afficher_resultat(JSON.parse(xhttp_ask.responseText));
                }
            };
            xhttp_ask.open("GET", "search/" + document.getElementById("imputRecherche").value, true);
            xhttp_ask.send();
        }
    });




</script>

</body>
</html>