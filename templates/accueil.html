<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/styleGlobal.css') }}">
    <script type="text/javascript" src="{{ url_for('static', filename='scripts/jquery-3.2.1.min.js') }}"></script>
    <link rel= "stylesheet" type= "text/css" href= "../static/styles/styleGlobal.css    ">


    <title>Page Accueil</title>
</head>
<body>

<div class="listMusique">
    <div id="Lecture_en_cours" class="ItemMusique">
        <div class="imageAlbum">
            <img src="https://upload.wikimedia.org/wikipedia/en/4/4b/Therion_fleurs_2.jpg"/>
        </div>
        <div class="infosMusique">
            <h1>Titre Musique</h1>
            <h2>Artiste/Album</h2>

            <div class="ProgressBarCV">
                <div class="ContainerStandard ContenuProgressBarCV" style="width:45%"></div>
            </div>
            <p>1:34 / 4:35</p>
        </div>
    </div>


    <div class="ItemMusique">
        <div class="imageAlbum">
            <img src="https://upload.wikimedia.org/wikipedia/en/4/4b/Therion_fleurs_2.jpg"/>
        </div>
        <div class="infosMusique">
            <h1>Titre Musique</h1>
            <h2>Artiste/Album</h2>
        </div>
    </div>


    <div class="ItemMusique">
        <div class="imageAlbum">
            <img src="https://upload.wikimedia.org/wikipedia/en/4/4b/Therion_fleurs_2.jpg"/>
        </div>
        <div class="infosMusique">
            <h1>Titre Musique</h1>
            <h2>Artiste/Album</h2>
        </div>
    </div>

</div>

<header>
    <form>
        <input name="q" id="imputRecherche" type="text" placeholder="Recherchez un morceau"
                spellcheck="false" dir="ltr" style="text-align: left; direction: ltr;"
                aria-expanded="false"/>
        <div class="list_result" id="listresultat">
        </div>
    </form>
</header>

<script>
    /// partie synchronisation
    var xhttp_sync = new XMLHttpRequest();
    xhttp_sync.onreadystatechange = function(){
        if(this.readyState == 4 && this.status == 200)
        {
            // Lecture du Json
        }
    };
    xhttp_sync.open("GET", "sync", true);
    xhttp_sync.send();



    ///  afficher résultat barre de recherche

    //  Liste des résultats de la recherche
    var listResultatsAffiches = [];

    //  fonction qui envoie au serveur l'URL du morceau a ajouter à la playlist
    function ajouterALaPlaylist()
    {
        var xhttp_add = new XMLHttpRequest();
        xhttp_add.open("GET", "add/" + this.getAttribute("id"), true);
        xhttp_add.send();
    }

    //  fonction a executer à chaque fois que le serveur nous envoie de nouvelles informations sur la recherche
    function afficher_resultat(json)
    {
        //  On supprime les anciennes recherches
        listResultatsAffiches.forEach(function(element){
           element.removeEventListener('click', ajouterALaPlaylist);
        });
        listResultatsAffiches.clear();

        //  On ajoute les nouvelles
        document.getElementById("listresultat").innerHTML = '';
        json.forEach(function(morceau){
            document.getElementById("listresultat").innerHTML +=
                '<div class="ItemMusique itemDeRecherche" id="' + morceau.url + '" >' +
                    '<div class="imageAlbum">' +
                        '<img src="' + morceau.albumart_url + '"/>' +
                    '</div>' +
                    '<div class="infosMusique">' +
                        '<h1>' + morceau.track + '</h1>' +
                        '<h2>' + morceau.artist + '</h2>' +
                    '</div>' +
                '</div>';
        });

        //  On ajoute le listener d'évènement pour ajouter le morceau clické à la playliste
        listResultatsAffiches = document.getElementsByClassName("itemDeRecherche");
        listResultatsAffiches.forEach(function(element){
           element.addEventListener('click', ajouterALaPlaylist);
        });
    }

    document.getElementById("imputRecherche").addEventListener("keydown", function(){
        var xhttp_ask = new XMLHttpRequest();
        xhttp_ask.onreadystatechange = function(){
            if(this.readyState == 4 && this.status == 200)
            {
                afficher_resultat(JSON.parse(xhttp_ask.responseText));
            }
        };
        xhttp_ask.open("GET", "search/" + Document.getElementById("imputRecherche").getAttribute("value"), true);
        xhttp_ask.send();
    });




</script>

</body>
</html>